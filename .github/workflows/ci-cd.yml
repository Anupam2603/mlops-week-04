name: CI-CD Pipeline for Iris API
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
env:
  GCP_PROJECT_ID: "stunning-agency-472702-a0" 
  GKE_CLUSTER_NAME: "week-06-cluster"        
  GKE_REGION: "us-central1"                  
  ARTIFACT_REGISTRY: "iris-api-repo"         
  DEPLOYMENT_NAME: "iris-api-deployment"     
  IMAGE_NAME: "iris-api" 
jobs:
  # --- JOB 1: Continuous Integration (Testing) ---
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Pytest
      env:
        # Provide the *public* IP of your VM as a secret
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
      run: pytest
# --- JOB 2: Continuous Deployment (Build & Deploy) ---
  build-and-deploy:
    name: Build and Deploy to GKE
    # This job only runs IF the 'test' job succeeds
    needs: test
    runs-on: ubuntu-latest
    
    # This job needs permissions to write to Artifact Registry
    # and talk to GKE.
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout repository code
      uses: actions/checkout@v3

    # --- Authenticate with GCP ---
    - name: Authenticate to Google Cloud
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        # Use the JSON key you downloaded for your service account
        credentials_json: '${{ secrets.GCP_CD_SERVICE_ACCOUNT_KEY }}'
        
    - name: Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v2'
   
    # Install the gke-gcloud-auth-plugin.
    # This is required for kubectl to authenticate with GKE.
    - name: Install gke-gcloud-auth-plugin
      run: gcloud components install gke-gcloud-auth-plugin
    # --- Build and Push Docker Image ---
    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.GKE_REGION }}-docker.pkg.dev

    - name: Build Docker Image
      run: docker build -t ${{ env.IMAGE_NAME }}:latest .

    - name: Tag Docker Image
      run: |
        docker tag ${{ env.IMAGE_NAME }}:latest \
        ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Push Docker Image to Artifact Registry
      run: |
        docker push \
        ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
# --- Deploy to Kubernetes (GKE) ---
    - name: Get GKE Cluster Credentials
      # This configures 'kubectl' (the Kubernetes command line tool)
      # to talk to your GKE cluster
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} \
        --region ${{ env.GKE_REGION }}

    - name: Deploy to GKE
      # This is the "magic" step. It applies your "instruction manuals"
      # to the cluster. Kubernetes will see the new image path
      # and automatically start a "rolling update" to your new version.
      run: |
        # 1. Update the deployment.yml with the *exact* new image path
        sed -i 's|image: .*|image: ${{ env.GKE_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/${{ env.IMAGE_NAME }}:latest|' k8s/deployment.yml
        
        # 2. Apply both instruction manuals
        kubectl apply -f k8s/deployment.yml
        kubectl apply -f k8s/service.yml
